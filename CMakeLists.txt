cmake_minimum_required(VERSION 3.16)

project(steps3d_vulkan)

# –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–¥–Ω–æ–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä
# –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω–∞
if(NOT CMAKE_CONFIGURATION_TYPES AND NOT CMAKE_BUILD_TYPE)
    # —Ç–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –±—É–¥–µ—Ç Release
    set(CMAKE_BUILD_TYPE Release)
    # –ù–µ–ª—å–∑—è –æ—Å—Ç–∞–≤–ª—è—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é CMAKE_BUILD_TYPE –ø—É—Å—Ç–æ–π,
    # —Ç–∞–∫ –∫–∞–∫ –ø—Ä–∏ —ç—Ç–æ–º –Ω–µ –±—É–¥—É—Ç –∑–∞–¥–∞–Ω—ã —Ñ–ª–∞–≥–∏ GCC –∏ MinGW
endif()

# –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º –æ–± in-source build
if(CMAKE_BINARY_DIR MATCHES "^${CMAKE_SOURCE_DIR}")
    message(WARNING "–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç—ã –≤ –ø–∞–ø–∫–µ —Å –∏—Ö–æ–¥–Ω–∏–∫–∞–º–∏ - –ø–ª–æ—Ö–∞—è –∏–¥–µ—è")
endif()

# --------- –°—Ç–æ—Ä–æ–Ω–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ ---------

find_package(Vulkan REQUIRED)
#if(WIN32)
#    target_compile_definitions(Vulkan::Vulkan INTERFACE VK_USE_PLATFORM_WIN32_KHR)
#else() # Linux
#    target_compile_definitions(Vulkan::Vulkan INTERFACE VK_USE_PLATFORM_XCB_KHR)
#    # –ú–æ–∂–µ—Ç –±—ã—Ç—å –µ—â—ë VK_USE_PLATFORM_WAYLAND_KHR –∏–ª–∏ VK_USE_PLATFORM_XLIB_KHR
#endif()

add_subdirectory(third_party/external/glfw)
add_subdirectory(third_party/external/glm)
add_subdirectory(third_party/external/stb)
add_subdirectory(third_party/external/vulkan_memory_allocator)

# --------- –ü—Ä–∏–º–µ—Ä—ã ---------

# –í–µ—Ä—Å–∏—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞ C++
set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# –£–∫–∞–∑—ã–≤–∞–µ–º –°—Ç—É–¥–∏–∏ –Ω–∞ —Ç–æ, —á—Ç–æ –∏—Å—Ö–æ–¥–Ω–∏–∫–∏ –≤ –∫–æ–¥–∏—Ä–æ–≤–∫–µ UTF-8.
# –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–∏—Å–∞—Ç—å U'üçå'. –£ –¥—Ä—É–≥–∏—Ö –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–æ–≤, –ø–æ—Ö–æ–∂–µ, –Ω–µ—Ç —Å —ç—Ç–∏–º –ø—Ä–æ–±–ª–µ–º.
# https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2295r6.pdf
if(MSVC)
    add_compile_options(/utf-8)
endif()

# –°–æ–∑–¥–∞—ë—Ç —Å—Å—ã–ª–∫—É –¥–ª—è –ø–∞–ø–∫–∏. –ï—Å–ª–∏ —Å—Å—ã–ª–∫—É —Å–æ–∑–¥–∞—Ç—å –Ω–µ —É–¥–∞–ª–æ—Å—å, —Ç–æ –∫–æ–ø–∏—Ä—É–µ—Ç –ø–∞–ø–∫—É
function(create_dir_link from to)
    if(EXISTS ${to})
        return()
    endif()

    if(NOT CMAKE_HOST_WIN32)
        execute_process(COMMAND ${CMAKE_COMMAND} -E create_symlink ${from} ${to}
                        OUTPUT_QUIET ERROR_QUIET RESULT_VARIABLE RESULT)
    else()
        # –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º create_symlink –≤ Windows, —Ç–∞–∫ –∫–∞–∫ —Å–æ–∑–¥–∞–Ω–∏–µ symbolic links
        # [—Ç—Ä–µ–±—É–µ—Ç –∞–¥–º–∏–Ω—Å–∫–∏—Ö –ø—Ä–∞–≤](https://ss64.com/nt/mklink.html),
        # –∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ junctions –∏–∑ CMake
        # [–±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞](https://gitlab.kitware.com/cmake/cmake/-/merge_requests/7530)
        string(REPLACE / \\ from ${from})
        string(REPLACE / \\ to ${to})
        execute_process(COMMAND cmd /C mklink /J ${to} ${from}
                        OUTPUT_QUIET ERROR_QUIET RESULT_VARIABLE RESULT)
    endif()

    if(NOT RESULT EQUAL 0)
        # –ü—Ä–∏—á–∏–Ω–æ–π –Ω–µ—É–¥–∞—á–∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è PATH, –≤ –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç %SystemRoot%\system32
        message("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É –¥–ª—è –ø–∞–ø–∫–∏, –ø–æ—ç—Ç–æ–º—É –∫–æ–ø–∏—Ä—É–µ–º –ø–∞–ø–∫—É")
        execute_process(COMMAND ${CMAKE_COMMAND} -E copy_directory  ${from} ${to})
    endif()
endfunction()

# –ö—É–¥–∞ –±—É–¥—É—Ç –ø–æ–º–µ—â–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —ç–∫–∑–µ—à–Ω–∏–∫–∏
set(bin_dir ${CMAKE_BINARY_DIR}/result)

# –°–æ–∑–¥–∞—ë–º –ø–∞–ø–∫—É
file(MAKE_DIRECTORY ${bin_dir})

# –î–ª—è –æ–¥–Ω–æ–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤ (MinGW)
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${bin_dir})
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${bin_dir})

# –î–ª—è –º–Ω–æ–≥–æ–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤ (Visual Studio)
foreach(config_name ${CMAKE_CONFIGURATION_TYPES})
    string(TOUPPER ${config_name} config_name)
    set(CMAKE_RUNTIME_OUTPUT_DIRECTORY_${config_name} ${bin_dir})
    set(CMAKE_LIBRARY_OUTPUT_DIRECTORY_${config_name} ${bin_dir})
endforeach()

# –ß—Ç–æ–±—ã –ø—Ä–æ–≥—Ä–∞–º–º—ã –ø—Ä–∏ –æ—Ç–ª–∞–¥–∫–µ –Ω–∞—Ö–æ–¥–∏–ª–∏ —Ä–µ—Å—É—Ä—Å—ã
set(CMAKE_VS_DEBUGGER_WORKING_DIRECTORY ${bin_dir})
# –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è CMAKE_DEBUGGER_WORKING_DIRECTORY –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ CMake 4.0

# –ö–æ–ø–∏—Ä—É–µ–º –ø–∞–ø–∫–∏ —Å —Ä–µ—Å—É—Ä—Å–∞–º–∏ –≤ result
set(dir_names shaders)
foreach(dir_name ${dir_names})
    create_dir_link(${CMAKE_CURRENT_SOURCE_DIR}/${dir_name} ${bin_dir}/${dir_name})
endforeach()

# –ö–æ–ø–∏—Ä—É–µ–º dll-–∫–∏ MinGW 
if(MINGW)
    # dll-–∫–∏ MinGW –Ω–∞—Ö–æ–¥—è—Ç—Å—è —Ä—è–¥–æ–º —Å –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–æ–º, –ø–æ—ç—Ç–æ–º—É –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä—É
    execute_process(COMMAND where x86_64-w64-mingw32-gcc.exe
                    OUTPUT_VARIABLE mingw_fullpath)

    # –ö–æ–º–∞–Ω–¥–∞ where –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫, –µ—Å–ª–∏ MinGW —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ —Ä–∞–∑–Ω—ã–µ –º–µ—Å—Ç–∞.
    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤—ã–≤–æ–¥ –∫–æ–º–∞–Ω–¥—ã –≤ —Å–ø–∏—Å–æ–∫ –∏ –ø–æ–ª—É—á–∞–µ–º –Ω—É–ª–µ–≤–æ–π —ç–ª–µ–º–µ–Ω—Ç
    string(REPLACE "\n" ";" mingw_fullpath ${mingw_fullpath})
    list(GET mingw_fullpath 0 mingw_fullpath)

    cmake_path(GET mingw_fullpath PARENT_PATH mingw_dir)

    set(dlls ${mingw_dir}/libgcc_s_seh-1.dll
             ${mingw_dir}/libstdc++-6.dll
             ${mingw_dir}/libwinpthread-1.dll)

    foreach(dll ${dlls})
        execute_process(COMMAND ${CMAKE_COMMAND} -E copy_if_different ${dll} ${bin_dir})
    endforeach()
endif()

set(log_source_files ${CMAKE_CURRENT_SOURCE_DIR}/common/Log.cpp ${CMAKE_CURRENT_SOURCE_DIR}/common/Log.h)
set(data_source_files ${CMAKE_CURRENT_SOURCE_DIR}/common/Data.cpp ${CMAKE_CURRENT_SOURCE_DIR}/common/Data.h)

add_subdirectory(src_01)
add_subdirectory(src_02)
add_subdirectory(src_03)
add_subdirectory(src_04)
add_subdirectory(src_05)
add_subdirectory(src_07)
